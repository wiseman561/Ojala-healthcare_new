# ---------- build ----------
FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build
WORKDIR /src
COPY *.sln .
COPY Ojala.HealthScore.csproj ./
RUN dotnet restore

COPY . .
RUN dotnet publish Ojala.HealthScore.csproj -c Release -o /app/publish --no-restore

# ---------- runtime ----------
FROM mcr.microsoft.com/dotnet/aspnet:8.0 AS runtime
WORKDIR /app
COPY --from=build /app/publish .

# Create a non-root user/group
RUN groupadd --system appgroup && \
    useradd --system --gid appgroup --shell /bin/bash appuser
USER appuser

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=10s --retries=3 \
  CMD curl -f http://localhost/healthz || exit 1

EXPOSE 80
ENTRYPOINT ["dotnet", "Ojala.HealthScore.dll"]
